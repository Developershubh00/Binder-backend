# Binder Backend - Deployment Guide

## üöÄ Quick Start Commands

### Local Django Development

```bash
# 1. Navigate to project directory
cd binder_backend

# 2. Create and activate virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# 3. Install dependencies
pip install -r requirements.txt

# 4. Set up environment variables
cp .env.example .env
# Edit .env with your settings

# 5. Run migrations
python manage.py makemigrations
python manage.py migrate

# 6. Create superuser (optional)
python manage.py createsuperuser

# 7. Collect static files (for production-like testing)
python manage.py collectstatic --noinput

# 8. Run development server
python manage.py runserver
# Server will run on http://localhost:8000
```

### Frontend Development (React/Vite)

```bash
# 1. Navigate to frontend directory (if separate repo)
cd ../binder_frontend  # or your frontend path

# 2. Install dependencies
npm install
# or
yarn install

# 3. Create .env file for frontend
echo "VITE_API_URL=http://localhost:8000/api" > .env

# 4. Run development server
npm run dev
# or
yarn dev
# Frontend will run on http://localhost:5173 (Vite) or http://localhost:3000 (React)
```

### Production Commands (Render/OLS Django)

#### For Render Deployment:

```bash
# Build command (automatically runs on Render)
pip install -r requirements.txt && python manage.py collectstatic --noinput

# Start command (automatically runs on Render)
gunicorn binder_config.wsgi:application
```

#### Manual Production Setup:

```bash
# 1. Set production environment variables
export DEBUG=False
export SECRET_KEY=your-production-secret-key
export DATABASE_URL=postgresql://user:password@host:port/dbname
export ALLOWED_HOSTS=your-domain.com,www.your-domain.com

# 2. Install dependencies
pip install -r requirements.txt

# 3. Run migrations
python manage.py migrate

# 4. Collect static files
python manage.py collectstatic --noinput

# 5. Start with Gunicorn
gunicorn binder_config.wsgi:application --bind 0.0.0.0:8000 --workers 4
```

## üìã Environment Variables

### Required for Local Development (.env file):

```env
# Django Settings
SECRET_KEY=your-secret-key-here
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# Database
DATABASE_URL=postgresql://binder_user:password@localhost:5432/binder_db
# Or separate variables:
DB_NAME=binder_db
DB_USER=binder_user
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# Email (optional for development)
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your_email@gmail.com
EMAIL_HOST_PASSWORD=your_app_password
DEFAULT_FROM_EMAIL=noreply@binder.com

# Google Sheets (optional)
GOOGLE_SHEETS_SPREADSHEET_ID=your_spreadsheet_id
GOOGLE_SHEETS_CREDENTIALS_FILE=credentials.json

# JWT Settings
JWT_ACCESS_TOKEN_LIFETIME=60
JWT_REFRESH_TOKEN_LIFETIME=1440
```

### Required for Render Production:

Set these in Render Dashboard ‚Üí Environment Variables:

```env
SECRET_KEY=<auto-generated or set manually>
DEBUG=False
DATABASE_URL=<auto-provided by Render PostgreSQL>
ALLOWED_HOSTS=<your-render-domain.onrender.com>
CORS_ALLOWED_ORIGINS=https://your-frontend-domain.com
RENDER_EXTERNAL_HOSTNAME=<auto-provided by Render>
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your_email@gmail.com
EMAIL_HOST_PASSWORD=your_app_password
DEFAULT_FROM_EMAIL=noreply@binder.com
```

## üîß Database Setup

### Local PostgreSQL:

```bash
# Create database
psql -U postgres
CREATE DATABASE binder_db;
CREATE USER binder_user WITH PASSWORD 'your_password';
ALTER ROLE binder_user SET client_encoding TO 'utf8';
ALTER ROLE binder_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE binder_user SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE binder_db TO binder_user;
\q
```

### Render PostgreSQL:

1. Create PostgreSQL database in Render Dashboard
2. Render automatically provides `DATABASE_URL` environment variable
3. No manual setup needed

## üì¶ Deployment Steps

### Deploy to Render:

1. **Push code to GitHub/GitLab**
   ```bash
   git add .
   git commit -m "Ready for Render deployment"
   git push origin main
   ```

2. **Connect to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" ‚Üí "Web Service"
   - Connect your repository

3. **Configure Service**
   - **Name**: binder-backend
   - **Environment**: Python 3
   - **Build Command**: `pip install -r requirements.txt && python manage.py collectstatic --noinput`
   - **Start Command**: `gunicorn binder_config.wsgi:application`
   - **Plan**: Starter (or higher)

4. **Add PostgreSQL Database**
   - Click "New +" ‚Üí "PostgreSQL"
   - Name: binder-db
   - Plan: Starter (or higher)
   - Connect to your web service

5. **Set Environment Variables**
   - Add all required variables from above
   - `SECRET_KEY`: Generate a strong random key
   - `DEBUG`: False
   - `ALLOWED_HOSTS`: Your Render domain
   - `CORS_ALLOWED_ORIGINS`: Your frontend domain

6. **Deploy**
   - Render will automatically build and deploy
   - Check logs for any errors

### Alternative: Manual Deployment (OLS Django)

If deploying to a VPS or other server:

```bash
# 1. SSH into server
ssh user@your-server.com

# 2. Clone repository
git clone https://github.com/your-org/binder_backend.git
cd binder_backend

# 3. Set up virtual environment
python3 -m venv venv
source venv/bin/activate

# 4. Install dependencies
pip install -r requirements.txt

# 5. Set environment variables
export DEBUG=False
export SECRET_KEY=your-secret-key
export DATABASE_URL=postgresql://...

# 6. Run migrations
python manage.py migrate

# 7. Collect static files
python manage.py collectstatic --noinput

# 8. Start with Gunicorn (or use systemd service)
gunicorn binder_config.wsgi:application --bind 0.0.0.0:8000 --workers 4

# 9. (Optional) Set up Nginx reverse proxy
# 10. (Optional) Set up systemd service for auto-start
```

## üîê Authentication Notes

**Important**: Email verification is currently **skipped** (auto-verified). Twilio verification will be added later.

- Users are automatically verified on registration
- No email verification required
- Login works immediately after registration

## üß™ Testing Commands

```bash
# Run Django tests
python manage.py test

# Run specific app tests
python manage.py test auth_service

# Check for issues
python manage.py check

# Validate migrations
python manage.py makemigrations --dry-run
```

## üìä Health Check

After deployment, check health endpoint:

```bash
# Local
curl http://localhost:8000/api/health/

# Production
curl https://your-domain.com/api/health/
```

## üêõ Troubleshooting

### Common Issues:

1. **Database Connection Error**
   - Check `DATABASE_URL` is correct
   - Verify PostgreSQL is running
   - Check firewall/network settings

2. **Static Files Not Loading**
   - Run `python manage.py collectstatic --noinput`
   - Check `STATIC_ROOT` in settings
   - Verify WhiteNoise is installed

3. **CORS Errors**
   - Add frontend URL to `CORS_ALLOWED_ORIGINS`
   - Check `CORS_ALLOW_CREDENTIALS` is True

4. **Migration Errors**
   - Run `python manage.py migrate --run-syncdb`
   - Check for conflicting migrations

## üìù Frontend Integration

### API Base URL:

```javascript
// Development
const API_URL = 'http://localhost:8000/api'

// Production
const API_URL = 'https://your-backend-domain.com/api'
```

### Authentication Headers:

```javascript
// Include JWT token in requests
headers: {
  'Authorization': `Bearer ${accessToken}`,
  'Content-Type': 'application/json'
}
```

## üöÄ Quick Commands Reference

```bash
# Development
python manage.py runserver

# Production
gunicorn binder_config.wsgi:application

# Migrations
python manage.py makemigrations
python manage.py migrate

# Static Files
python manage.py collectstatic --noinput

# Create Superuser
python manage.py createsuperuser

# Django Shell
python manage.py shell

# Check Configuration
python manage.py check --deploy
```

## üìû Support

For issues or questions:
- Check logs: `tail -f logs/debug.log`
- Review Render logs in dashboard
- Check Django admin: `/admin/`

